name: CI

on:
    push:
        branches: [main, master]
        tags: ["v*.*.*"]
    pull_request:
        branches: [main, master]
    workflow_dispatch: {}

env:
    CRATE: umi-checker

jobs:
    test:
        name: Tests, format & lint âœ…
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  components: rustfmt, clippy

            - name: Cache cargo registry & build
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Check formatting
              run: cargo fmt -- --check

            - name: Run clippy
              run: cargo clippy -- -D warnings

            - name: Run tests
              run: cargo test --all --verbose

    build-linux-x86_64:
        name: Build Linux x86_64 (release) ðŸ§
        runs-on: ubuntu-latest
        needs: test
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable

            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: target
                  key: ${{ runner.os }}-cargo-target

            - name: Build release
              run: |
                  cargo build --release

            - name: Package artifact
              run: |
                  VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version = "([^"]+)"/\1/')
                  mkdir -p dist
                  cp target/release/${{ env.CRATE }} dist/
                  strip dist/${{ env.CRATE }} || true
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-linux-x86_64.zip" dist/${{ env.CRATE }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-x86_64
                  path: dist/${{ env.CRATE }}-*.zip

    build-linux-aarch64:
        name: Build Linux aarch64 (cross) ðŸ§
        runs-on: ubuntu-latest
        needs: test
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust & Docker (for cross)
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable

            - name: Install cross
              run: cargo install --locked cross || true

            - name: Cross build aarch64-unknown-linux-gnu
              run: cross build --target aarch64-unknown-linux-gnu --release

            - name: Package artifact
              run: |
                  VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version = "([^"]+)"/\1/')
                  mkdir -p dist
                  cp target/aarch64-unknown-linux-gnu/release/${{ env.CRATE }} dist/${{ env.CRATE }}
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-linux-aarch64.zip" dist/${{ env.CRATE }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-aarch64
                  path: dist/${{ env.CRATE }}-*.zip

    build-windows:
        name: Build Windows x86_64 (release) ðŸªŸ
        runs-on: windows-latest
        needs: test
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable

            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: target
                  key: ${{ runner.os }}-cargo-target

            - name: Build release (Windows)
              shell: pwsh
              run: |
                  cargo build --release

            - name: Package artifact (Windows)
              shell: pwsh
              run: |
                  $version = Select-String -Path Cargo.toml -Pattern '^version' | Select-Object -First 1
                  $version = ($version -replace 'version = "([^"]+)"','$1')
                  New-Item -ItemType Directory -Path dist -Force | Out-Null
                  Copy-Item -Path target\release\${{ env.CRATE }}.exe -Destination dist\
                  Compress-Archive -LiteralPath dist\${{ env.CRATE }}.exe -DestinationPath dist\${{ env.CRATE }}-${version}-windows-x86_64.zip

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-windows-x86_64
                  path: dist/${{ env.CRATE }}-*.zip

    build-macos:
        name: Build macOS (release) ðŸŽ
        runs-on: macos-latest
        needs: test
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable

            - name: Build release (macOS)
              run: |
                  cargo build --release

            - name: Package artifact (macOS)
              run: |
                  VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version = "([^"]+)"/\1/')
                  mkdir -p dist
                  cp target/release/${{ env.CRATE }} dist/
                  ARCH=$(uname -m)
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-macos-${ARCH}.zip" dist/${{ env.CRATE }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-macos
                  path: dist/${{ env.CRATE }}-*.zip

    release:
        name: Create GitHub Release (tag) ðŸš€
        runs-on: ubuntu-latest
        needs: [build-linux-x86_64, build-linux-aarch64, build-windows, build-macos]
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - uses: actions/checkout@v4

            - name: Download Linux x86_64 artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-x86_64
                  path: artifacts

            - name: Download Linux aarch64 artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-aarch64
                  path: artifacts

            - name: Download Windows artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-windows-x86_64
                  path: artifacts

            - name: Download macOS artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-macos
                  path: artifacts

            - name: Generate checksums for release assets
              run: |
                  cd artifacts
                  # If no archives, exit early
                  shopt -s nullglob || true
                  FILES=( *.zip )
                  if [ ${#FILES[@]} -eq 0 ]; then
                    echo "No release artifacts found!"
                    ls -la
                    exit 0
                  fi

                  if command -v sha256sum >/dev/null 2>&1; then
                    sha256sum "${FILES[@]}" > checksums.txt
                  else
                    shasum -a 256 "${FILES[@]}" > checksums.txt
                  fi
                  echo "Checksums generated:"
                  cat checksums.txt

            - name: Get release notes
              id: release_notes
              run: |
                  TAG=${GITHUB_REF#refs/tags/}
                  # Try reading annotated tag message, fall back to simple label
                  NOTES=$(git for-each-ref --format='%(contents)' refs/tags/${TAG} || true)
                  if [ -z "${NOTES}" ]; then
                    NOTES="Release ${TAG}"
                  fi
                  echo "body<<EOF" >> $GITHUB_OUTPUT
                  echo "${NOTES}" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub release and attach assets
              uses: ncipollo/release-action@v1
              with:
                  tag: ${{ github.ref_name }}
                  name: ${{ github.ref_name }}
                  body: ${{ steps.release_notes.outputs.body }}
                  files: "artifacts/*"
                  draft: false
                  prerelease: false
