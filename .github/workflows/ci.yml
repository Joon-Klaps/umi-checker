name: CI

on:
    push:
        branches: [main, master]
        tags: ["v*.*.*"]
    pull_request:
        branches: [main, master]
    workflow_dispatch: {}

env:
    CRATE: umi-checker

jobs:
    test:
        name: Tests, format & lint âœ…
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  components: rustfmt, clippy

            - name: Cache cargo registry & build
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Check formatting
              run: cargo fmt -- --check

            - name: Run clippy
              run: cargo clippy -- -D warnings

            - name: Run tests
              run: cargo test --all --verbose

    coverage:
        name: Coverage test ðŸ“Š
        runs-on: ubuntu-latest
        needs: test
        container:
            image: xd009642/tarpaulin:develop-nightly
            options: --security-opt seccomp=unconfined
        if: "!startsWith(github.ref, 'refs/tags/v')"
        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Generate code coverage
              run: |
                  cargo +nightly tarpaulin --verbose --all-features --workspace --timeout 120 --out xml

            - name: Upload to codecov.io
              uses: codecov/codecov-action@v5
              with:
                  fail_ci_if_error: false
                  token: ${{ secrets.CODECOV_TOKEN }}

    build-linux-x86_64:
        name: Build Linux x86_64 (release) ðŸ§
        runs-on: ubuntu-latest
        needs: test
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable

            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: target
                  key: ${{ runner.os }}-cargo-target

            - name: Build release
              run: |
                  cargo build --release

            - name: Package artifact
              run: |
                  VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version = "([^"]+)"/\1/')
                  mkdir -p dist

                  # Prepare Raw Binary
                  cp target/release/${{ env.CRATE }} dist/${{ env.CRATE }}-Linux-x86_64

                  # Create zip
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-linux-x86_64.zip" dist/${{ env.CRATE }}-Linux-x86_64

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-x86_64
                  path: dist/*

    build-linux-aarch64:
        name: Build Linux ARM64 / AArch64 (release) ðŸ§
        runs-on: ubuntu-24.04-arm
        needs: test
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable

            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: target
                  key: ${{ runner.os }}-arm64-cargo-target

            - name: Build release
              run: |
                  cargo build --release

            - name: Package artifact
              run: |
                  VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version = "([^"]+)"/\1/')
                  mkdir -p dist

                  # Prepare Raw Binaries (both naming conventions)
                  cp target/release/${{ env.CRATE }} dist/${{ env.CRATE }}-Linux-aarch64
                  cp target/release/${{ env.CRATE }} dist/${{ env.CRATE }}-Linux-arm64

                  # Create zips using the binaries
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-linux-aarch64.zip" dist/${{ env.CRATE }}-Linux-aarch64
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-linux-arm64.zip" dist/${{ env.CRATE }}-Linux-arm64

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-aarch64
                  path: dist/*

    build-macos-x86_64:
        name: Build macOS x86_64 (release) ðŸŽ
        runs-on: macos-15-intel
        needs: test
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  target: x86_64-apple-darwin

            - name: Build release for Intel
              run: |
                  cargo build --release --target x86_64-apple-darwin

            - name: Package artifact
              run: |
                  VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version = "([^"]+)"/\1/')
                  mkdir -p dist

                  # Prepare Raw Binary
                  cp target/x86_64-apple-darwin/release/${{ env.CRATE }} dist/${{ env.CRATE }}-Darwin-x86_64

                  # Create zip
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-macos-x86_64.zip" dist/${{ env.CRATE }}-Darwin-x86_64

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-macos-x86_64
                  path: dist/*

    build-macos-arm:
        name: Build macOS ARM64 / AArch64 (release) ðŸŽ
        runs-on: macos-latest
        needs: test
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  target: aarch64-apple-darwin

            - name: Build release for ARM
              run: |
                  cargo build --release --target aarch64-apple-darwin

            - name: Package artifact
              run: |
                  VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version = "([^"]+)"/\1/')
                  mkdir -p dist

                  BIN=target/aarch64-apple-darwin/release/${{ env.CRATE }}

                  # Prepare Raw Binaries (both naming conventions)
                  cp "$BIN" dist/${{ env.CRATE }}-Darwin-aarch64
                  cp "$BIN" dist/${{ env.CRATE }}-Darwin-arm64

                  # Create zips using the binaries
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-macos-aarch64.zip" dist/${{ env.CRATE }}-Darwin-aarch64
                  zip -j "dist/${{ env.CRATE }}-${VERSION}-macos-arm64.zip" dist/${{ env.CRATE }}-Darwin-arm64

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.CRATE }}-macos-arm
                  path: dist/*

    release:
        name: Create GitHub Release (tag) ðŸš€
        runs-on: ubuntu-latest
        needs: [build-linux-x86_64, build-linux-aarch64, build-macos-x86_64, build-macos-arm]
        if: startsWith(github.ref, 'refs/tags/')
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Download Linux x86_64 artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-x86_64
                  path: artifacts

            - name: Download Linux aarch64 artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-linux-aarch64
                  path: artifacts

            - name: Download macOS x86_64 artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-macos-x86_64
                  path: artifacts

            - name: Download macOS ARM artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.CRATE }}-macos-arm
                  path: artifacts

            - name: Generate checksums for release assets
              run: |
                  cd artifacts
                  shopt -s nullglob || true
                  FILES=( * )
                  FILES=( $(printf "%s\n" "${FILES[@]}" | grep -v '^checksums.txt$' || true) )
                  if [ ${#FILES[@]} -eq 0 ]; then
                    echo "No release artifacts found!"
                    ls -la
                    exit 0
                  fi

                  if command -v sha256sum >/dev/null 2>&1; then
                    sha256sum "${FILES[@]}" > checksums.txt
                  else
                    shasum -a 256 "${FILES[@]}" > checksums.txt
                  fi
                  echo "Checksums generated:"
                  cat checksums.txt

            - name: Get release notes
              id: release_notes
              run: |
                  TAG=${GITHUB_REF#refs/tags/}
                  # Try reading annotated tag message, fall back to simple label
                  NOTES=$(git for-each-ref --format='%(contents)' refs/tags/${TAG} || true)
                  if [ -z "${NOTES}" ]; then
                    NOTES="Release ${TAG}"
                  fi
                  echo "body<<EOF" >> $GITHUB_OUTPUT
                  echo "${NOTES}" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub release and attach assets
              uses: ncipollo/release-action@v1
              with:
                  tag: ${{ github.ref_name }}
                  name: ${{ github.ref_name }}
                  body: ${{ steps.release_notes.outputs.body }}
                  artifacts: "artifacts/*"
                  draft: false
                  prerelease: false
